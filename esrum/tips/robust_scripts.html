

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>6.4. Writing robust bash scripts &#8212; Esrum Cluster  documentation</title>
    <link rel="stylesheet" href="../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/playback.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/theme.css" />
    
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/js/custom.js"></script>
    <script src="../_static/js/libgif.js"></script>
    <script src="../_static/bizstyle.js"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7. Troubleshooting" href="../troubleshooting.html" />
    <link rel="prev" title="6.3. Batching commands outside Slurm" href="batching_commands.html" />
    <script defer src="../_static/js/playback.js"></script>

  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../troubleshooting.html" title="7. Troubleshooting"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="batching_commands.html" title="6.3. Batching commands outside Slurm"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Esrum Cluster  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U"><span class="section-number">6. </span>Tips and tricks</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">6.4. Writing robust bash scripts</a><ul>
<li><a class="reference internal" href="#improving-default-bash-behavior">6.4.1. Improving default bash behavior</a><ul>
<li><a class="reference internal" href="#prevent-use-of-undefined-variables">6.4.1.1. Prevent use of undefined variables</a></li>
<li><a class="reference internal" href="#stop-running-on-program-failures">6.4.1.2. Stop running on program failures</a></li>
<li><a class="reference internal" href="#prevent-bash-from-updating-running-scripts">6.4.1.3. Prevent bash from updating running scripts</a></li>
<li><a class="reference internal" href="#putting-it-all-together">6.4.1.4. Putting it all together</a></li>
</ul>
</li>
<li><a class="reference internal" href="#checking-your-scripts-for-common-mistakes">6.4.2. Checking your scripts for common mistakes</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="batching_commands.html"
                        title="previous chapter"><span class="section-number">6.3. </span>Batching commands outside Slurm</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../troubleshooting.html"
                        title="next chapter"><span class="section-number">7. </span>Troubleshooting</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="writing-robust-bash-scripts">
<span id="p-tips-robustscripts"></span><h1><span class="section-number">6.4. </span>Writing robust bash scripts<a class="headerlink" href="#writing-robust-bash-scripts" title="Permalink to this headline">¶</a></h1>
<p>Bash scripts are useful for automating tasks and for running batch jobs.
However the default behavior of bash is to keep running when errors
happen, and that can result in undesirable behavior such as running
programs with the wrong settings, analyzing bad data, and worse. This
page is written on the premise that it is better to fail loudly than to
generate bad results or do bad things quietly.</p>
<p>However, because of the many, many <a class="reference external" href="https://mywiki.wooledge.org/BashPitfalls">bash pitfalls</a>, it is also
recommended to use a more robust programming language when performing
more complex tasks.</p>
<div class="section" id="improving-default-bash-behavior">
<h2><span class="section-number">6.4.1. </span>Improving default bash behavior<a class="headerlink" href="#improving-default-bash-behavior" title="Permalink to this headline">¶</a></h2>
<p>This section describes several options that can make bash scripts behave
in a more reasonable manner.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>While it is possible to set these options in your shell, this is
<em>not</em> recommended since it will break scripts not designed with these
options in mind and can result in your terminal closing every time
you make a typo. For the same reason you <em>must not</em> set these options
in scripts that you import into your shell using the <code class="docutils literal notranslate"><span class="pre">source</span></code> or
<code class="docutils literal notranslate"><span class="pre">.</span></code> command.</p>
</div>
<div class="section" id="prevent-use-of-undefined-variables">
<h3><span class="section-number">6.4.1.1. </span>Prevent use of undefined variables<a class="headerlink" href="#prevent-use-of-undefined-variables" title="Permalink to this headline">¶</a></h3>
<p>Variables are used for a variety of purposes in bash, including to
access slurm options in batch scripts. However, unlike in most
programming languages, it is not an error to access a variable that does
not exist:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ cat myscript.sh
<span class="c1">#!/bin/bash</span>
<span class="nv">MY_VARIABLE</span><span class="o">=</span><span class="s2">&quot;record&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Tourist: I will not buy this </span><span class="si">${</span><span class="nv">MY_VARIABL</span><span class="si">}</span><span class="s2">, it is scratched.&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Clerk: Sorry?&quot;</span>
$ bash myscript.sh
Tourist: I will not buy this , it is scratched.
Clerk: Sorry?
</pre></div>
</div>
<p>Note how the script keeps executing even though we made a mistake. A
common mistake is therefore to misspell variables in scripts and have
bash silent do the wrong thing.</p>
<p>While there are cases where it is useful to allow missing variables,
most of the time this is a mistake. To prevent this, you can set the
<code class="docutils literal notranslate"><span class="pre">nounset</span></code> option, which causes bash to terminate on unset variables:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ cat myscript.sh
<span class="c1">#!/bin/bash</span>
<span class="nb">set</span> -o nounset  <span class="c1"># Exit on unset variables</span>
<span class="nv">MY_VARIABLE</span><span class="o">=</span><span class="s2">&quot;record&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Tourist: I will not buy this </span><span class="si">${</span><span class="nv">MY_VARIABL</span><span class="si">}</span><span class="s2">, it is scratched.&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Clerk: Sorry?&quot;</span>
$ bash myscript.sh
test.sh: line <span class="m">4</span>: MY_VARIABL: unbound variable
</pre></div>
</div>
<p>This not only tells us that there is a problem with our script (and
where!), but it also stops bash from doing any more damage.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Should you <em>want</em> to allow a variable to be unset while using
<code class="docutils literal notranslate"><span class="pre">nounset</span></code>, you can use the <code class="docutils literal notranslate"><span class="pre">${name:-default}</span></code> pattern, where
<code class="docutils literal notranslate"><span class="pre">name</span></code> is the name of a variable and <code class="docutils literal notranslate"><span class="pre">default</span></code> is the text you
want to use if <code class="docutils literal notranslate"><span class="pre">name</span></code> is not set. To match the default behavior of
bash simply use <code class="docutils literal notranslate"><span class="pre">${name:-}</span></code>.</p>
</div>
</div>
<div class="section" id="stop-running-on-program-failures">
<h3><span class="section-number">6.4.1.2. </span>Stop running on program failures<a class="headerlink" href="#stop-running-on-program-failures" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="prevent-bash-from-updating-running-scripts">
<h3><span class="section-number">6.4.1.3. </span>Prevent bash from updating running scripts<a class="headerlink" href="#prevent-bash-from-updating-running-scripts" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="putting-it-all-together">
<h3><span class="section-number">6.4.1.4. </span>Putting it all together<a class="headerlink" href="#putting-it-all-together" title="Permalink to this headline">¶</a></h3>
<p>The following bash script template combines the suggestions above and
thereby helps avoid <em>some</em> of the pitfalls of using bash</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1"># FIXME: SBATCH commands go here!</span>

<span class="o">{</span>
<span class="nb">set</span> -o nounset  <span class="c1"># Exit on unset variables</span>
<span class="nb">set</span> -o pipefail <span class="c1"># Exit on unhandled failure in pipes</span>
<span class="nb">set</span> -o errtrace <span class="c1"># Have functions inherit ERR traps</span>
<span class="c1"># Print debug message and terminate script on non-zero return codes</span>
<span class="nb">trap</span> <span class="s1">&#39;s=$?; echo &gt;&amp;2 &quot;$0: Error on line &quot;$LINENO&quot;: $BASH_COMMAND&quot;; exit $s&#39;</span> ERR

<span class="c1"># FIXME: Your commands go here!</span>

<span class="c1"># Prevent the script from continuing if the file has changed</span>
<span class="nb">exit</span> <span class="nv">$?</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Note however that is not guaranteed to catch all</p>
</div>
</div>
<div class="section" id="checking-your-scripts-for-common-mistakes">
<h2><span class="section-number">6.4.2. </span>Checking your scripts for common mistakes<a class="headerlink" href="#checking-your-scripts-for-common-mistakes" title="Permalink to this headline">¶</a></h2>
<p>In addition to implementing the suggestions listed on this page, it is
recommended that you use the <a class="reference external" href="https://github.com/koalaman/shellcheck">shellcheck</a> to check your bash scripts for
common mistakes.</p>
<p>For example, if we run shell check on the very first script shown on
this page:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>$ module load shellcheck
$ shellcheck myscript.sh

In myscript.sh line <span class="m">2</span>:
<span class="nv">MY_VARIABLE</span><span class="o">=</span><span class="s2">&quot;record&quot;</span>
^---------^ SC2034 <span class="o">(</span>warning<span class="o">)</span>: MY_VARIABLE appears unused. Verify use <span class="o">(</span>or <span class="nb">export</span> <span class="k">if</span> used externally<span class="o">)</span>.

In myscript.sh line <span class="m">3</span>:
<span class="nb">echo</span> <span class="s2">&quot;I will not buy this </span><span class="si">${</span><span class="nv">MY_VARIABL</span><span class="si">}</span><span class="s2">, it is scratched.&quot;</span>
                        ^-----------^ SC2153 <span class="o">(</span>info<span class="o">)</span>: Possible misspelling: MY_VARIABL may not be assigned. Did you mean MY_VARIABLE?
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../troubleshooting.html" title="7. Troubleshooting"
             >next</a></li>
        <li class="right" >
          <a href="batching_commands.html" title="6.3. Batching commands outside Slurm"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Esrum Cluster  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" ><span class="section-number">6. </span>Tips and tricks</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2023, CBMR Phenomics.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.4.4.
    </div>
  </body>
</html>